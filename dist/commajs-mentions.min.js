!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("commajs-core")):"function"==typeof define&&define.amd?define(["commajs-core"],e):"object"==typeof exports?exports.CommaMentionsManager=e(require("commajs-core")):t.CommaMentionsManager=e(t["commajs-core"])}(window,function(n){return r={},i.m=o=[function(t,e){t.exports=n},function(t,e,n){"use strict";n.r(e),n.d(e,"CommaMentionsFactory",function(){return v}),n.d(e,"CommaMention",function(){return a});var l=n(0);function u(t){return(u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function o(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function i(t,e,n){return e&&o(t.prototype,e),n&&o(t,n),t}function r(t,e){return(r=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function s(r){var s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}();return function(){var t,e,n,o,i=c(r);return e=s?(t=c(this).constructor,Reflect.construct(i,arguments,t)):i.apply(this,arguments),n=this,!(o=e)||"object"!==u(o)&&"function"!=typeof o?function(t){if(void 0!==t)return t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(n):o}}function c(t){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}var a=function(){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&r(t,e)}(u,l["Plugin"]);var n=s(u);function u(t){var e;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,u),(e=n.call(this,t)).options=e.rootNode.document.GetPluginOptions("mentions"),e.InitializeDomElements(),e}return i(u,null,[{key:"GetName",value:function(){return"mentions"}}]),i(u,[{key:"InitializeDomElements",value:function(t){var e;null==this.rootNode.parent?(e=this,null==t?t=0:t++,t<50?setTimeout(function(){e.InitializeDomElements(t)},100):console.log("#555-23")):this.Init()}},{key:"Init",value:function(){var t,e=this,n=this.rootNode.domElement,o=n.getAttribute("cm-ment-entry");this.entry=void 0,null==o||""==o?(this.entry=JSON.parse(n.getAttribute("cm-ment-params")),t=n.getAttribute("cm-ment-type"),this.entry.mentionType=t):null!=o&&""!=o&&(this.entry=JSON.parse(l.Base64.decode(o))),n.addEventListener("click",function(){e.Click()}),n.addEventListener("mouseover",function(){e.MouseOver()}),n.addEventListener("mouseout",function(){e.MouseOut()})}},{key:"Click",value:function(){null!=this.options&&null!=this.options.externalFunctions&&null!=this.options.externalFunctions.OnClick&&this.options.externalFunctions.OnClick(this.entry,this.rootNode)}},{key:"MouseOver",value:function(){null!=this.options&&null!=this.options.externalFunctions&&null!=this.options.externalFunctions.OnMouseOver&&this.options.externalFunctions.OnMouseOver(this.entry,this.rootNode)}},{key:"MouseOut",value:function(){null!=this.options&&null!=this.options.externalFunctions&&null!=this.options.externalFunctions.OnMouseOut&&this.options.externalFunctions.OnMouseOut(this.entry,this.rootNode)}},{key:"OnMentionDeleted",value:function(){null!=this.options&&null!=this.options.externalFunctions&&null!=this.options.externalFunctions.OnMentionDeleted&&this.options.externalFunctions.OnMentionDeleted(this.entry,this.rootNode)}},{key:"Fire",value:function(t){return t===l.PluginActions.NODE_UNREGISTERED&&this.OnMentionDeleted(),!1}}],[{key:"CreateNew",value:function(t,e){t.DeleteSelection();var n=t.GetStyleAtCurrentCursorPosition();null!=n.nodeStyle&&null!=n.nodeStyle.fontSize&&n.nodeStyle.fontSize.on;var o=e,i=l.Base64.encode(JSON.stringify(o)),r=l.InlineNode.CreateNew(t,"span","",void 0,[{name:"cm-ment-entry",value:i},{name:"contenteditable",value:!1}]);if(t.InsertNodeAtCursor(r),!t.GetPluginOptions("mentions").externalFunctions.FormatMention(o,r)){var s=new u(r);return setTimeout(function(){null!=r.next&&r.next.isTextNode()&&r.next.SetFocus()},200),s}r.Delete(!0)}}]),u}();function h(t){return(h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function f(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function d(t,e,n){return e&&f(t.prototype,e),n&&f(t,n),t}function p(t,e){return(p=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function y(r){var s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}();return function(){var t,e,n,o,i=m(r);return e=s?(t=m(this).constructor,Reflect.construct(i,arguments,t)):i.apply(this,arguments),n=this,!(o=e)||"object"!==h(o)&&"function"!=typeof o?function(t){if(void 0!==t)return t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(n):o}}function m(t){return(m=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}var v=function(){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&p(t,e)}(o,l["Plugin"]);var n=y(o);function o(t){var e;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,o),(e=n.call(this,t)).options=e.rootNode.document.GetPluginOptions("mentionsFactory"),e.verifyAt=!1,e.searchResults=[],e.searchBoxes=[],e.arrowPosition=-1,e.highlightOnMouse=!1,e.searchingMention=!1,e.preserveTextHasBeenCalculated=!1,e.preserveTextAfterAt="",e}return d(o,null,[{key:"GetName",value:function(){return"mentionsFactory"}}]),d(o,[{key:"Destroy",value:function(){if(null!=this.searchPnl)try{this.searchPnl.parentNode.removeChild(this.searchPnl)}catch(t){}this.rootNode.document.RemovePluginInstance(this.rootNode.id)}},{key:"Search",value:function(t){var e=this;""!=t&&null!=this.options.externalFunctions.Search?(this._startSearching(),this.options.externalFunctions.Search(t).then(function(t){null!=(e.searchResults=t).hits&&(e.searchResults=t.hits),e._stopSearching()},function(t){console.log("Searching for mentions error",t)})):this._stopSearching()}},{key:"_startSearching",value:function(){this.searchingMention||(this.searchingMention=!0,this.UpdatePnl())}},{key:"_stopSearching",value:function(){this.searchingMention=!1,this.UpdatePnl()}},{key:"UpdatePnl",value:function(){for(var t=this.searchPnl;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(this.GenerateResultsPnl())}},{key:"Start",value:function(){var t,e=this.rootNode.document.GetSelectionBoundingClientRect(),n=e.left+"px",o=300+e.left+16;o>window.innerWidth&&(t=o-window.innerWidth,n=e.left-t+"px");var i=document.createElement("div");i.style.position="absolute",i.style.zIndex="99999",i.style.border="1px solid #cccccc",i.style.borderRadius="4px",i.style.backgroundColor="#ffffff",i.style.left=n,i.style.top=window.scrollY+2+e.height+e.top+"px",i.style.width="300px",i.style.minHeight="40px",i.style.maxHeight="160px",i.style.overflow="auto",(this.searchPnl=i).appendChild(this.GenerateResultsPnl()),document.body.appendChild(i)}},{key:"GenerateResultsPnl",value:function(){var t,e,n,o,i,r,s,u=this,l=document.createElement("div");return 0==this.searchResults.length?(1==this.options.showAbove&&((t=this.rootNode.document.GetSelectionBoundingClientRect().top-48)<0&&(t=0),this.searchPnl.style.top=window.scrollY+t+"px"),l.style.display="flex",l.style.justifyContent="center",l.style.alignItems="center",l.style.margin="10px",(e=document.createElement("div")).style.flex="1",e.style.fontSize="12px",e.style.fontFamily="Verdana",e.style.color="#aaaaaa",this.searchingMention?e.textContent="Searching...":e.textContent="Keep typing to search...",l.appendChild(e),(n=document.createElement("div")).style.color="#aaaaaa",o=document.createElement("i"),this.searchingMention?(n.style.paddingTop="1px",n.style.fontSize="18px",o.setAttribute("class","fa fa-circle-o-notch fa-spin")):(n.style.fontSize="20px",o.setAttribute("class","fa fa-times"),n.style.cursor="pointer",n.addEventListener("mouseover",function(t){this.style.color="#30b7e8"}),n.addEventListener("mouseout",function(t){this.style.color="#aaaaaa"}),n.addEventListener("mousedown",function(t){u.Destroy(),t.preventDefault(),t.stopPropagation()})),n.appendChild(o),l.appendChild(n)):(1==this.options.showAbove&&(r=(i=this.rootNode.document.GetSelectionBoundingClientRect()).top-168,2==this.searchResults.length?r=i.top-108:1==this.searchResults.length&&(r=i.top-58),r<0&&(r=0),this.searchPnl.style.top=window.scrollY+r+"px"),this.searchBoxes=[],this.arrowPosition=-1,this.highlightOnMouse=!1,l.style.opacity="0",s=0,this.searchResults.forEach(function(t){l.appendChild(u.GenerateResultItemPnl(s,t)),s++}),null!=this.prevTimeout&&clearTimeout(this.prevTimeout),this.prevTimeout=setTimeout(function(){l.style.opacity="1"},50)),l}},{key:"GenerateResultItemPnl",value:function(t,e){var n=this,o=this.options.externalFunctions.FormatEntry(e);return null!=o?(o.setAttribute("cm-entry-id",t),o.style.cursor="pointer",o.style.padding="4px 0px 4px 0px",o.setAttribute("tabindex","123"+t),o.addEventListener("mousemove",function(t){n.highlightOnMouse=!0}),o.addEventListener("mouseover",function(t){n.highlightOnMouse&&(o.style.backgroundColor="#ededed")}),o.addEventListener("mouseout",function(t){o.style.backgroundColor="#ffffff"}),o.addEventListener("mousedown",function(t){n.AddMentions(e)})):console.log("Panel undefined - cannot list item",e),this.searchBoxes.push(o),o}},{key:"ManagerArrowUp",value:function(){this.arrowPosition--,this.arrowPosition<0&&(this.arrowPosition=0),this.HighlightEntry()}},{key:"ManagerArrowDown",value:function(){this.arrowPosition++,this.arrowPosition>=this.searchBoxes.length&&(this.arrowPosition=this.searchBoxes.length-1),this.HighlightEntry()}},{key:"HighlightEntry",value:function(){var t;this.searchBoxes.forEach(function(t){t.style.backgroundColor="#ffffff"}),-1<this.arrowPosition&&this.arrowPosition<this.searchBoxes.length&&((t=this.searchBoxes[this.arrowPosition]).style.backgroundColor="#ededed",t.scrollIntoView(!1))}},{key:"AddMentionFromKeyboard",value:function(){var t,e,n;-1==this.arrowPosition&&(this.arrowPosition=0),-1<this.arrowPosition&&this.arrowPosition<this.searchBoxes.length&&(t=this.searchBoxes[this.arrowPosition],e=parseInt(t.getAttribute("cm-entry-id")),null!=(n=this.searchResults[e])&&this.AddMentions(n))}},{key:"AddMentions",value:function(t){var e=this.rootNode.text.indexOf("@"),n=this.rootNode.text.length-this.preserveTextAfterAt.length,o={idStartNode:this.rootNode.id,idEndNode:this.rootNode.id,startOffset:e,endOffset:n};this.rootNode.document.SetCursorPosition(o),this.rootNode.document.DeleteSelection(o),this.rootNode.document.InsertPluginAtSection(a.GetName(),t),this.Destroy()}},{key:"CalculateTextToPreserver",value:function(){this.preserveTextHasBeenCalculated=!0;var t=this.rootNode.text.indexOf("@")+1;this.preserveTextAfterAt=this.rootNode.text.substring(t)}},{key:"Fire",value:function(t){var e=!1;switch(this.preserveTextHasBeenCalculated||this.CalculateTextToPreserver(),t){case l.PluginActions.LOST_FOCUS:this.Destroy();break;case l.PluginActions.ARROW_UP:e=!0,this.ManagerArrowUp();break;case l.PluginActions.ARROW_DOWN:e=!0,this.ManagerArrowDown();break;case l.PluginActions.DELETE:case l.PluginActions.DELETE_TOP:case l.PluginActions.DELETE_FROM_BOTTOM:case l.PluginActions.CANCEL_FROM_TOP:case l.PluginActions.CANCEL_FROM_BOTTOM:case l.PluginActions.DELETE_BEFORE_INLINE:case l.PluginActions.CANCEL_BEFORE_INLINE:case l.PluginActions.NODE_UNREGISTERED:-1==this.rootNode.text.indexOf("@")?this.Destroy():this.verifyAt=!0;break;case l.PluginActions.ENTER:case l.PluginActions.TAB:e=!0,this.AddMentionFromKeyboard();break;case l.PluginActions.ESC:this.Destroy(),e=!0;break;case l.PluginActions.NEW_CHAR_ADDED:var n,o,i,r=event.key;"Tab"!=r&&"Meta"!=r&&"Shift"!=r&&"Alt"!=r&&"Control"!=r&&"Down"!=r&&"ArrowDown"!=r&&"Up"!=r&&"ArrowUp"!=r&&"Left"!=r&&"ArrowLeft"!=r&&"Right"!=r&&"ArrowRight"!=r&&"CapsLock"!=r&&"Enter"!=r&&"Esc"!=r&&"Escape"!=r&&("Backspace"==r&&(this.verifyAt=!0),n=!0,this.verifyAt&&(this.verifyAt=!1,-1==this.rootNode.text.indexOf("@")&&(this.Destroy(),n=!1)),n&&(o=this.rootNode.text.indexOf("@")+1,i=this.rootNode.text.substring(o),0<this.preserveTextAfterAt.length&&(i=i.slice(0,-1*this.preserveTextAfterAt.length)),this.Search(i)));break;default:return}return e}}],[{key:"CreateNew",value:function(t){var e=new o(t.GetNodeAtCursor());return e.Start(),e}}]),o}()}],i.c=r,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)i.d(n,o,function(t){return e[t]}.bind(null,o));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="/",i(i.s=1);function i(t){if(r[t])return r[t].exports;var e=r[t]={i:t,l:!1,exports:{}};return o[t].call(e.exports,e,e.exports,i),e.l=!0,e.exports}var o,r});